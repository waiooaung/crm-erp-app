name: Deploy to DigitalOcean

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to Server via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        password: ${{ secrets.DO_PASSWORD }}
        port: 22
        script: |
          # 1. Fix Git Ownership Issue
          git config --global --add safe.directory /var/www/crm-erp-app

          # Navigate to project
          cd /var/www/crm-erp-app

          # 2. Safely Enable Maintenance Mode (Only if artisan works)
          if [ -f artisan ]; then
              php artisan down || true
          fi

          # Pull latest changes
          git pull origin main

          # 3. Install PHP Dependencies (Now using PHP 8.4 on server)
          composer install --no-dev --optimize-autoloader

          # Install JS Dependencies & Build
          npm install
          npm run build

          # Run Migrations
          php artisan migrate --force

          # Link Storage
          php artisan storage:link

          # Filament optimizations
          php artisan filament:optimize
          php artisan icons:cache

          # Clear caches
          php artisan optimize:clear
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache

          # 4. Fix Permissions (Crucial step)
          sudo chown -R www-data:www-data /var/www/crm-erp-app
          sudo chmod -R 775 /var/www/crm-erp-app/storage
          sudo chmod -R 775 /var/www/crm-erp-app/bootstrap/cache

          # Run Seeders
          php artisan db:seed --force

          # Bring site back up
          php artisan up
